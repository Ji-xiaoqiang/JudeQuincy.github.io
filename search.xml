<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[Oracle 存储过程]]></title>
    <url>%2F2019%2F05%2F07%2Foracle_stored_procedure%2F</url>
    <content type="text"><![CDATA[存储过程创建语法： create [or replace] procedure 存储过程名（param1 in type，param2 out type）as 变量1 类型（值范围）; 变量2 类型（值范围）; Begin Select count(*) into 变量1 from 表A where列名=param1； If (判断条件) then Select 列名 into 变量2 from 表A where列名=param1； Dbms_output。Put_line(‘打印信息’); Elsif (判断条件) then Dbms_output。Put_line(‘打印信息’); Else Raise 异常名（NO_DATA_FOUND）; End if; Exception When others then Rollback; End; 注意事项：1. 存储过程参数不带取值范围，in表示传入，out表示输出2. 变量带取值范围，后面接分号3. 在判断语句前最好先用count(*)函数判断是否存在该条操作记录4. 用select … into … 给变量赋值5. 在代码中抛异常用 raise+异常名 已命名的异常: 命名的系统异常 产生原因 ACCESS_INTO_NULL 未定义对象 CASE_NOT_FOUND CASE 中若未包含相应的 WHEN ，并且没有设置ELSE 时 COLLECTION_IS_NULL 集合元素未初始化 CURSER_ALREADY_OPEN 游标已经打开 DUP_VAL_ON_INDEX 唯一索引对应的列上有重复的值 INVALID_CURSOR 在不合法的游标上进行操作 INVALID_NUMBER 内嵌的 SQL 语句不能将字符转换为数字 NO_DATA_FOUND 使用 select into 未返回行，或应用索引表未初始化的 TOO_MANY_ROWS 执行 select into 时，结果集超过一行 ZERO_DIVIDE 除数为 0 SUBSCRIPT_BEYOND_COUNT 元素下标超过嵌套表或 VARRAY 的最大值 SUBSCRIPT_OUTSIDE_LIMIT 使用嵌套表或 VARRAY 时，将下标指定为负数 VALUE_ERROR 赋值时，变量长度不足以容纳实际数据 LOGIN_DENIED PL/SQL 应用程序连接到 oracle 数据库时，提供了不正确的用户名或密码 NOT_LOGGED_ON PL/SQL 应用程序在没有连接 oralce 数据库的情况下访问数据 PROGRAM_ERROR PL/SQL 内部问题，可能需要重装数据字典＆ pl./SQL系统包 ROWTYPE_MISMATCH 宿主游标变量与 PL/SQL 游标变量的返回类型不兼容 SELF_IS_NULL 使用对象类型时，在 null 对象上调用对象方法 STORAGE_ERROR 运行 PL/SQL 时，超出内存空间 SYS_INVALID_ID 无效的 ROWID 字符串 TIMEOUT_ON_RESOURCE Oracle 在等待资源时超时 基本语法1. 基本结构 CREATE OR REPLACE PROCEDURE 存储过程名字 ( 参数1 IN NUMBER, 参数2 IN NUMBER ) IS 变量1 INTEGER :=0; 变量2 DATE; BEGIN --执行体 END 存储过程名字; 2. SELECT INTO STATEMENT将select查询的结果存入到变量中，可以同时将多个列存储多个变量中，必须有一条记录，否则抛出异常(如果没有记录抛出NO_DATA_FOUND)例子： BEGIN SELECT col1,col2 into 变量1,变量2 FROM typestruct where xxx; EXCEPTION WHEN NO_DATA_FOUND THEN xxxx; END; 3. IF 判断IF V_TEST=1 THEN BEGIN do something END; END IF; 4. while 循环WHILE V_TEST=1 LOOP BEGIN XXXX END; END LOOP; 5. 变量赋值V_TEST := 123; 6. 用for in 使用cursor IS CURSOR cur IS SELECT * FROM xxx; BEGIN FOR cur_result in cur LOOP BEGIN V_SUM :=cur_result.列名1+cur_result.列名2 END; END LOOP; END; 7. 带参数的cursor CURSOR C_USER(C_ID NUMBER) IS SELECT NAME FROM USER WHERE TYPEID=C_ID; OPEN C_USER(变量值); LOOP FETCH C_USER INTO V_NAME; EXIT FETCH C_USER%NOTFOUND; do something END LOOP; CLOSE C_USER; 8. 用pl/sql developer debug连接数据库后建立一个Test WINDOW,在窗口输入调用SP的代码,F9开始debug,CTRL+N单步调试 关于oracle存储过程的若干问题备忘 1.在oracle中，数据表别名不能加as，如：select a.appname from appinfo a;-- 正确 select a.appname from appinfo as a;-- 错误 也许，是怕和oracle中的存储过程中的关键字as冲突的问题吧 2.在存储过程中，select某一字段时，后面必须紧跟into，如果select整个记录，利用游标的话就另当别论了。 select af.keynode into kn from APPFOUNDATION af where af.appid=aid and af.foundationid=fid;-- 有into，正确编译 select af.keynode from APPFOUNDATION af where af.appid=aid and af.foundationid=fid;-- 没有into，编译报错，提示：Compilation Error: PLS-00428: an INTO clause is expected in this SELECT statement 3.在利用select…into…语法时，必须先确保数据库中有该条记录，否则会报出”no data found”异常。可以在该语法之前，先利用select count(*) from 查看数据库中是否存在该记录，如果存在，再利用select…into… 4.在存储过程中，别名不能和字段名称相同，否则虽然编译可以通过，但在运行阶段会报错 --正确 select keynode into kn from APPFOUNDATION where appid=aid and foundationid=fid; --错误 select af.keynode into kn from APPFOUNDATION af where af.appid=appid and af.foundationid=foundationid; -- 运行阶段报错，提示ORA-01422:exact fetch returns more than requested number of rows 5.在存储过程中，关于出现null的问题假设有一个表A，定义如下： create table A( id varchar2(50) primary key not null, vcount number(8) not null, bid varchar2(50) not null -- 外键 ); 如果在存储过程中，使用如下语句： select sum(vcount) into fcount from A where bid=&#39;xxxxxx&#39;; 如果A表中不存在bid=”xxxxxx”的记录，则fcount=null(即使fcount定义时设置了默认值，如：fcount number(8):=0依然无效，fcount还是会变成null)，这样以后使用fcount时就可能有问题，所以在这里最好先判断一下： if fcount is null then fcount:=0; end if; 这样就一切ok了。 6.Hibernate调用oracle存储过程this.pnumberManager.getHibernateTemplate().execute( new HibernateCallback() { public Object doInHibernate(Session session) throws HibernateException, SQLException { CallableStatement cs = session .connection() .prepareCall(&quot;{call modifyapppnumber_remain(?)}&quot;); cs.setString(1, foundationid); cs.execute(); return null; } });]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>PLSQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[PLSQL]]></title>
    <url>%2F2019%2F05%2F02%2FPLSQL%2F</url>
    <content type="text"><![CDATA[1.PLSQL编程程序结构declare --声明变量、游标 I INTEGER; begin --执行语句 --[异常处理] end； 打印 BEGIN DBMS_OUTPUT.PUT.LINE(&#39;hello world&#39;); END； 需要的开输出 PL/SQL procedure successfully completed 1.常见的变量 普通的数据类型 （char,varchar2,date,numder,boolean,long) 特殊变量类型(引用型变量、记录型变量) 声明变量的方式为变量名 变量类型（变量长度） 例如 v_name carchar2(20); 2.普通变量的赋值1.直接赋值语句:= bi 比如 v_name :=&#39;zhangsan&#39;2.语句赋值，使用 select ...into ...赋值；（语法select 值 into 变量） 3.应用型变量变量的类型和长度取决于表中字段的类型和长度通过表明.列名%TYPE指定变量的类型和长度，列入v_name emp.ename%TYPE; 4. 记录型变量接收表中的一整行记录，相当于java中的一个对象语法：变量名称 表名%ROWTYPE, 例如v_emp emp%rowtype; 流程控制1. 条件分支语法 BEGIN IF 条件1 THEN 执行1 ELSIF 条件2 THEN 执行2 ELSE 执行3 END IF; END; 注意关键字 ELSIF 2. 循环语法 BEGIN LOoP EXIT WHEN 突出循环条件 END LOOP; END; 游标1.什么是游标 用于临时存储一个查询返回的多行数据（结果集，类似于Java的连接返回的ResultSet集合），通过遍历游标，可以逐行访问处理该结果集的数据。 游标的使用方法：声明–&gt;打开–&gt;读取–&gt;关闭2. 语法 游标的声明： CURSOR 游标名[(参数列表)] IS 查询语句； 游标的打开：OPEN 游标名； 游标的取值：FETCH 游标名 INTO 变量列表； 游标的关闭：CLOSE 游标名；3. 游标的属性 游标的属性 返回值类型 说明 %ROWCOUNT 整形 获得FETCH语句返回的数据行 %FOUND 布尔型 最近的FETCH语句一行数据则真，否则为假 %NOTFOUND 布尔型 与%FOUND属性返回值相反 %ISOPEN 布尔型 游标已经打开时值为真，否则为假 注意%NOTFOUND属性默认为FLASE,所以在循环中要注意判断条件的位置，如果先判断在FETCH会导致最后一个条记录的值会被打印两次（多循环一次默认）； 存储过程1.语法CREATE OR REOLACE PROCEDURE 存储过程名[(参数列表)] IS BEGIN END[存储过程名]； 不带参数-带输入参数 带输入输出参数（返回值）的 带输出参数的存储过程CREATE OR REOLACE PROCEDURE 存储过程名[(参数列表)] IS BEGIN END[存储过程名]； 参数 –IN输入 –OUT输出]]></content>
      <categories>
        <category>学习笔记</category>
      </categories>
      <tags>
        <tag>PLSQL</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hello World]]></title>
    <url>%2F2019%2F04%2F28%2Fhello-world%2F</url>
    <content type="text"><![CDATA[Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post$ hexo new &quot;My New Post&quot; More info: Writing Run server$ hexo server More info: Server Generate static files$ hexo generate More info: Generating Deploy to remote sites$ hexo deploy More info: Deployment]]></content>
  </entry>
</search>
